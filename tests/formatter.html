<!DOCTYPE html>
<html>

<head>
  <title>VexFlow 2 - JavaScript Music Notation and Guitar Tab</title>
  <link rel="stylesheet" href="flow.css" type="text/css" media="screen" />
  <!-- VexFlow Sources -->
  <script src="../build/vexflow-debug.js"></script>

  <script>
    const VF = Vex.Flow;

    function runSubgroupTest(el, iterations, params) {
      const options = {
        width: 650,
        height: 350,
        systemWidth: 550,
        debug: true,
        ...params,
      };

      let vf = new VF.Factory({
        renderer: {
          elementId: el,
          width: options.width,
          height: options.height,
        }
      });

      vf.StaveNote = vf.StaveNote.bind(vf);

      var stave1 = vf.Stave({ x: 15, y: 30, width: options.systemWidth }).setClef('treble');
      var notes1 = [
        { keys: ['f/5'], stem_direction: 1, duration: '4' },
        { keys: ['d/4'], stem_direction: 1, duration: '4', clef: 'bass' },
        { keys: ['c/5'], stem_direction: 1, duration: '4', clef: 'alto' },
        { keys: ['c/5'], stem_direction: 1, duration: '4', clef: 'soprano' },
      ].map(vf.StaveNote);

      var notes2 = [
        { keys: ['c/4'], stem_direction: -1, duration: '4' },
        { keys: ['c/3'], stem_direction: -1, duration: '4', clef: 'bass' },
        { keys: ['d/4'], stem_direction: -1, duration: '4', clef: 'alto' },
        { keys: ['f/4'], stem_direction: -1, duration: '4', clef: 'soprano' },
      ].map(vf.StaveNote);

      var stave2 = vf.Stave({ x: 15, y: 150, width: options.systemWidth }).setClef('bass');

      var notes3 = [
        { keys: ['e/3'], duration: '8', stem_direction: -1, clef: 'bass' },
        { keys: ['g/4'], duration: '8', stem_direction: 1, clef: 'treble' },
        { keys: ['d/4'], duration: '8', stem_direction: 1, clef: 'treble' },
        { keys: ['f/4'], duration: '8', stem_direction: 1, clef: 'treble' },
        { keys: ['c/4'], duration: '8', stem_direction: 1, clef: 'treble' },
        { keys: ['g/3'], duration: '8', stem_direction: -1, clef: 'bass' },
        { keys: ['d/3'], duration: '8', stem_direction: -1, clef: 'bass' },
        { keys: ['f/3'], duration: '8', stem_direction: -1, clef: 'bass' },
      ].map(vf.StaveNote);

      vf.StaveConnector({ top_stave: stave1, bottom_stave: stave2, type: 'brace' });
      vf.StaveConnector({ top_stave: stave1, bottom_stave: stave2, type: 'singleLeft' });
      vf.StaveConnector({ top_stave: stave1, bottom_stave: stave2, type: 'singleRight' });

      function addAccidental(note, acc) {
        return note.addModifier(0, vf.Accidental({ type: acc }));
      }
      function addSubGroup(note, subNotes) {
        return note.addModifier(0, vf.NoteSubGroup({ notes: subNotes }));
      }

      vf.Beam({ notes: notes3.slice(1, 4) });
      vf.Beam({ notes: notes3.slice(5) });

      addAccidental(notes1[1], '#');
      addSubGroup(notes1[1], [
        vf.ClefNote({ type: 'bass', options: { size: 'small' } }),
        vf.TimeSigNote({ time: '3/4' }),
      ]);
      addSubGroup(notes2[2], [
        vf.ClefNote({ type: 'alto', options: { size: 'small' } }),
        vf.TimeSigNote({ time: '9/8' }),
      ]);
      addSubGroup(notes1[3], [vf.ClefNote({ type: 'soprano', options: { size: 'small' } })]);
      addSubGroup(notes3[1], [vf.ClefNote({ type: 'treble', options: { size: 'small' } })]);
      addSubGroup(notes3[5], [vf.ClefNote({ type: 'bass', options: { size: 'small' } })]);
      addAccidental(notes3[0], '#');
      addAccidental(notes3[3], 'b');
      addAccidental(notes3[5], '#');
      addAccidental(notes1[2], 'b');
      addAccidental(notes2[3], '#');

      var voice = vf.Voice().addTickables(notes1);
      var voice2 = vf.Voice().addTickables(notes2);
      var voice3 = vf.Voice().addTickables(notes3);

      const formatter = vf.Formatter();
      formatter
        .joinVoices([voice, voice2])
        .joinVoices([voice3])
        .formatToStave([voice, voice2, voice3], stave1);

      for (let i = 0; i < iterations; i++) {
        formatter.tune();
      }

      vf.draw();
      if (options.debug) {
        VF.Formatter.plotDebugging(vf.getContext(), formatter, stave1.getNoteStartX(), 10, 320);
      }
    }

    function runTest(el, iterations, params) {
      const options = {
        width: 600,
        height: 800,
        systemWidth: 500,
        debug: true,
        ...params,
      };

      let vf = new VF.Factory({
        renderer: {
          elementId: el,
          width: options.width,
          height: options.height,
        }
      });

      var system = vf.System({
        x: 50,
        width: options.systemWidth,
        debugFormatter: options.debug,
        formatIterations: iterations
      });

      var score = vf.EasyScore();

      var newVoice = function (notes) {
        return score.voice(notes, { time: '1/4' });
      };

      var newStave = function (voice) {
        return system
          .addStave({ voices: [voice], debugNoteMetrics: options.debug })
          .addClef('treble')
          .addTimeSignature('1/4');
      };

      var voices = [
        score.notes('c5/8, c5'),
        score.tuplet(score.notes('a4/8, a4, a4'), { notes_occupied: 2 }),
        score.notes('c5/16, c5, c5, c5'),
        score.tuplet(score.notes('a4/16, a4, a4, a4, a4'), { notes_occupied: 4 }),
        score.tuplet(score.notes('a4/32, a4, a4, a4, a4, a4, a4'), { notes_occupied: 8 }),
      ];

      voices.map(newVoice).forEach(newStave);
      system.addConnector().setType(VF.StaveConnector.type.BRACKET);

      vf.draw();
    }

    class FrameStack {
      constructor(parentEl, numFrames, params) {
        this.parentEl = parentEl;
        this.numFrames = numFrames;
        this.options = {
          prefix: 'vex-frame-',
          ...params
        }

        this.frames = [];
        this.currentFrame = 0;
        this.install();
      }

      frameID(i) {
        return `${this.options.prefix}${i}`;
      }

      install() {
        document.getElementById(this.parentEl).innerHTML = "";
        for (let i = 0; i < this.numFrames; i++) {
          let div = document.createElement('div');
          div.id = this.frameID(i);
          div.style.position = "absolute";
          div.style.top = 0;
          div.style.left = 0;
          div.style.width = '100%';
          div.style.height = '100%';
          div.style.display = 'none';
          div.innerHTML = `<h2>Iteration ${i}</h2>`;

          document.getElementById(this.parentEl).appendChild(div);
          this.frames[i] = div;
        }
      }

      get(i) {
        return this.frames[i];
      }

      show(i) {
        document.getElementById(this.frameID(this.currentFrame)).style.display = 'none';
        document.getElementById(this.frameID(i)).style.display = 'block';
        this.currentFrame = i;
      }

      startAnimation(params) {
        const options = {
          start: 0,
          end: this.numFrames,
          intervalms: 100,
          ...params,
        }

        this.animationTimer = setInterval(() => {
          let frame = this.currentFrame + 1 == this.numFrames ? 0 : this.currentFrame + 1;
          this.show(frame);
        }, options.intervalms);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const iterations = 100;
      VF.Registry.enableDefaultRegistry();
      const frameStack = new FrameStack('canvas', iterations);

      for (let i = 0; i < iterations; i++) {
        runTest(frameStack.frameID(i), i, { debug: true });
      }

      frameStack.startAnimation();
      VF.Registry.disableDefaultRegistry();
    });
  </script>
</head>

<body>
  <div style="text-align: center;">
    <div id="qunit"></div>
    <div id="qunit-fixture"></div>
    <div>
      <h2>
        [ <a href="http://vexflow.com">Home</a> ]
        [ <a href="http://github.com/0xfe/vexflow">GitHub</a> ]
      </h2>

      <div>
        <h1>
          Formatter Tests
        </h1>

        <div id="container"
          style="width: 100%; height: 80%; text-align: center; display: flex; align-items: center; justify-content: center;">
          <div id="canvas" style="position: relative; margin: auto; width: 80%;"></div>
        </div>

      </div>
    </div>

    <p style="position: fixed; bottom: 0; width: 100%; text-align: center;">
      [ <a href="http://vexflow.com">home</a> ]
      [ <a href="http://github.com/0xfe/vexflow">github</a> ]
      [ <a href="http://0xfe.muthanna.com">0xfe</a> ]
    </p>
  </div>
</body>

</html>