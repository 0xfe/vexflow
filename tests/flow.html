<!DOCTYPE html>
<html>
  <head>
    <title>VexFlow - JavaScript Music Notation and Guitar Tab</title>
    <link rel="stylesheet" href="flow.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="support/qunit.css" type="text/css" media="screen" />
  </head>
  <body>
    <div style="text-align: center">
      <div id="qunit"></div>
      <div id="qunit-fixture"></div>
      <div>
        <h2>[ <a href="http://vexflow.com">Home</a> ] [ <a href="http://github.com/0xfe/vexflow">GitHub</a> ]</h2>
        <h3>
          See the: <a id="vex-src" target="_blank"></a>. Don't forget to run the
          <a href="https://github.com/0xfe/vexflow/wiki/Visual-Regression-Tests">Visual Regression Tests</a>!
        </h3>
      </div>
      <p>&nbsp;</p>
      <div id="vexflow_testoutput"></div>
      <p>&nbsp;</p>
      <p class="vf-footer">
        [ <a href="http://vexflow.com">home</a> ] [ <a href="http://github.com/0xfe/vexflow">github</a> ] [
        <a href="http://0xfe.muthanna.com">0xfe</a> ]
      </p>
    </div>
    <script type="module">
      function loadScript(url) {
        return new Promise((resolve, reject) => {
          let script = document.createElement('script');
          script.onload = resolve;
          script.onerror = reject;
          script.src = url;
          // The utf-8 charset is required for the measureText cache,
          // since the index contains weird unicode characters.
          script.charset = 'utf-8';
          document.getElementsByTagName('head')[0].appendChild(script);
        });
      }

      // Support a query param to choose which VexFlow version to load.
      // ver=(build|reference|releases|etc...)
      // If omitted, ver defaults to 'build'.
      let params = new URLSearchParams(window.location.search);
      let param_ver = params.get('ver');

      let vexURL;
      let testsURL;
      let isAtLeastVersion4 = true;

      // `ver` can also specify a version hosted on unpkg.com:
      //   ver=unpkg@3.0.9  or  ver=unpkg@1.2.77
      // https://unpkg.com/vexflow@3.0.9/releases/vexflow-debug.js
      if (param_ver && param_ver.includes('unpkg')) {
        let version = param_ver.split('@')[1];
        vexURL = `https://unpkg.com/vexflow@${version}/releases/vexflow-debug.js`;
        testsURL = `https://unpkg.com/vexflow@${version}/releases/vexflow-tests.js`;
        if (parseFloat(version) < 4) {
          isAtLeastVersion4 = false;
        }
      } else {
        let path = param_ver || 'build';

        // RONYEH: For now, we assume the 'releases' folder is version 3.0.9.
        // Before we ship 4.0, we'll need to update this to reflect any changes to the releases/ folder.
        if (path === 'releases') {
          isAtLeastVersion4 = false;
        }
        vexURL = '../' + path + '/vexflow-debug.js';
        testsURL = '../' + path + '/vexflow-tests.js';
      }

      // Display which VexFlow version we loaded, if the `ver` param was specified.
      let info = param_ver !== null ? ` [${param_ver}]` : '';
      const srcLink = document.getElementById('vex-src');
      srcLink.href = vexURL;
      srcLink.innerText = 'VexFlow Source' + info;

      let loadVexFlow;
      if (isAtLeastVersion4) {
        // When loading version >= 4.0.0, only load vexflow-tests.js
        loadVexFlow = () => loadScript(testsURL);
      } else {
        // When loading versions <= 3.0.9, load both vexflow-debug.js and vexflow-tests.js
        loadVexFlow = () => loadScript(vexURL).then(() => loadScript(testsURL));
      }

      await loadVexFlow();
      await Vex.Flow.Font.loadWebFonts();

      // Load qunit.js as late as possible to avoid a race condition!
      // The QUnit module drop down box doesn't appear if Vex.Flow.Test.run() runs too late.
      await loadScript('support/qunit.js');

      // Show only failed tests.
      QUnit.config.hidepassed = true;
      QUnit.config.noglobals = true;
      Vex.Flow.Test.run();

      // Optional: view the loaded fonts.
      // await document.fonts.ready;
      // document.fonts.forEach((fontFace) => console.log(fontFace));
    </script>
  </body>
</html>
